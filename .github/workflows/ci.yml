name: 2048-ci/cd-job

on:
  workflow_dispatch:

env:
  AWS_ACCOUNT_ID: ${{ vars.aws_account_id }}

permissions:
  contents: write
  pull-requests: write

jobs:
  Code-Quality:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: setup node env
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: cache dependencies
        id: cache-primes
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: install dependencies
        run: npm install

      - name: linting
        run: npm run lint

      - name: Run Trivy vulnerability scanner in fs mode
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: "fs"
          scan-ref: "."
          trivy-config: trivy.yaml

  Docker-build:
    runs-on: ubuntu-latest
    needs: Code-Quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build and Push Docker Image
        run: | 
          IMAGE_URI=$AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/2048-app:${{ github.sha }}
          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI

  staging-deploy:
      needs: Docker-build
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v5
          with:
            token: ${{ secrets.GITHUB_TOKEN }}
            ref: develop
            fetch-depth: 0

        - name: Changes to staging manifest
          run: |
            sed -i "s|image: $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/2048-app:.*|image: $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/2048-app:${{ github.sha }}|" \
            k8/staging/deployment.yml
        
        - name: Push changes to git
          run: |
            git config --global user.name 'GitHub Actions'
            git config --global user.email 'actions@github.com'
            git add k8/staging/deployment.yml
            git commit -m "Update stage image to ${{ github.sha }}"
            git push origin develop

  pr-prod-deploy:
      needs: staging-deploy
      runs-on: ubuntu-latest
      env:
        FEATURE_BRANCH: prod-deploy-${{ github.run_number }}-${{ github.sha }}
      steps:
        - name: Checkout code
          uses: actions/checkout@v5
          with:
            token: ${{ secrets.GITHUB_TOKEN }}
            fetch-depth: 0

        - name: Changes to PROD manifest
          run: |
            sed -i "s|image: $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/2048-app:.*|image: $AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/2048-app:${{ github.sha }}|" \
            k8/prod/deployment.yml
          
        - name: Commit prod changes
          run: |
            git config --global user.name 'GitHub Actions'
            git config --global user.email 'actions@github.com'
            git checkout -b ${{ env.FEATURE_BRANCH }}
            git add k8/prod/deployment.yml
            git commit -m "Promote to prod: Update image to ${{ github.sha }}" || echo "No changes to commit"
            git push origin ${{ env.FEATURE_BRANCH }}

        - name: Create Pull Request
          uses: peter-evans/create-pull-request@v6
          with:
            token: ${{ secrets.GITHUB_TOKEN }}
            branch: ${{ env.FEATURE_BRANCH }}
            base: master
            title: "ðŸš€ Promote to Production"
            body: |
              ## Production Deployment Request
            
              This PR promotes the changes from develop to production.
            
              ### Details
              - **Image Tag**: `${{ github.sha }}`
              - **Commit SHA**: `${{ github.sha }}`
              - **Stage Deployment**: âœ… Successful
            
              ### Changes
              - Updated production deployment manifest with new image
            
              ### Deployment Steps
              1. Review the changes
              2. Approve and merge this PR
              3. ArgoCD will automatically sync the changes to production
            
              ---
              **Note**: Stage environment has been successfully deployed and tested.
            labels: |
              deployment
              production
              auto-generated
            draft: false